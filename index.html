<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crypto Testnet Hub | Kelola Testnet Pribadi</title>
  <link rel="stylesheet" href="style.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>
<body>

  <!-- HEADER -->
  <header class="main-header">
    <div class="logo">
      <i class="fas fa-satellite-dish"></i> TesNetID
    </div>
    <nav class="nav-menu">
      <a href="#" class="active" data-target="home">Home</a>
      <a href="#" data-target="dashboard">Dashboard</a>
      <a href="#" id="auth-nav-link" class="cta-button" data-target="auth">Login / Register</a>
    </nav>
  </header>

  <main id="app-content">

    <!-- HOME -->
    <section id="home-section" class="content-section active">
      <div class="hero-section">
        <h1>Buat <strong>List Testnetmu Sendiri</strong> untuk Garapan Maksimal</h1>
        <p>Atur, pantau, dan maksimalkan potensi airdrop dengan daftar testnet yang dikustomisasi sesuai strategi Anda.</p>
        <a href="#" class="primary-btn" data-target="dashboard">Mulai Kelola Daftar Anda</a>
      </div>
      <div class="info-cards">
        <div class="card"><i class="fas fa-list-check"></i><h3>Kustomisasi Prioritas</h3><p>Atur proyek berdasarkan potensi, kesulitan, dan alokasi waktu Anda.</p></div>
        <div class="card"><i class="fas fa-lock-open"></i><h3>Kunci Potensi Airdrop</h3><p>Jangan lewatkan tugas penting dengan sistem pemantauan proyek pribadi.</p></div>
        <div class="card"><i class="fas fa-chart-line"></i><h3>Pantauan Progress</h3><p>Tandai status garapan Anda (To Do, In Progress, Done) secara real-time.</p></div>
      </div>
    </section>

    <!-- AUTH (Login / Register) -->
    <section id="auth-section" class="content-section">
      <div class="auth-container">
        <!-- Login Box -->
        <div class="auth-box login-box" id="login-box">
          <h2>Selamat Datang Kembali</h2>
          <form id="login-form">
            <div class="form-group">
              <label for="log-email">Email</label>
              <input type="email" id="log-email" required placeholder="alamat@email.com"/>
            </div>
            <div class="form-group">
              <label for="log-password">Password</label>
              <input type="password" id="log-password" required placeholder="Minimal 8 karakter"/>
            </div>
            <button type="submit" class="primary-btn">Login</button>
          </form>
          <p class="switch-auth">Belum punya akun? <a href="#" id="show-register">Register</a></p>
        </div>

        <!-- Register Box -->
        <div class="auth-box register-box hidden" id="register-box">
          <h2>Buat Akun Baru</h2>
          <form id="register-form">
            <div class="form-group">
              <label for="reg-email">Email</label>
              <input type="email" id="reg-email" required placeholder="alamat@email.com"/>
            </div>
            <div class="form-group">
              <label for="reg-password">Password</label>
              <input type="password" id="reg-password" required placeholder="Minimal 8 karakter"/>
            </div>
            <div class="form-group">
              <label for="reg-confirm">Konfirmasi Password</label>
              <input type="password" id="reg-confirm" required placeholder="Ulangi password"/>
            </div>
            <button type="submit" class="primary-btn">Register</button>
          </form>
          <p class="switch-auth">Sudah punya akun? <a href="#" id="show-login">Login</a></p>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard-section" class="content-section">
      <h2 class="dashboard-title"><i class="fas fa-tasks"></i> DASHBOARD TESTNET & AIRDROP TRACKER</h2>

      <div class="search-filter-bar">
        <input type="text" id="searchInput" placeholder="Cari proyek..." class="search-input"/>
        <select id="filterStatus" class="filter-select">
          <option value="">Semua Status</option>
          <option value="Aktif">Aktif</option>
          <option value="Selesai">Selesai</option>
        </select>
        <select id="filterTier" class="filter-select">
          <option value="">Semua Tier</option>
          <option value="Tier 1">Tier 1</option>
          <option value="Tier 2">Tier 2</option>
          <option value="Tier 3">Tier 3</option>
        </select>
        <button id="addProjectBtn" class="primary-btn">Tambah Proyek Baru</button>
      </div>

      <div class="testnet-list">
        <div class="testnet-card header-row">
          <span>NAMA PROYEK</span>
          <span>LINK</span>
          <span>TIER</span>
          <span>TUGAS UTAMA</span>
          <span>SELESAI</span>
          <span>AKSI</span>
        </div>
        <div id="testnet-list-container">
          <p style="text-align:center;padding:60px;color:var(--text-muted);">Memuat data...</p>
        </div>
      </div>
    </section>

  </main>

  <!-- MODAL TAMBAH -->
  <div id="add-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>Tambah Proyek Baru</h2>
      <form id="addForm">
        <div class="form-group"><label>Nama Proyek</label><input type="text" name="name" required/></div>
        <div class="form-group"><label>Link Dokumentasi</label><input type="url" name="link" required/></div>
        <div class="form-group"><label>Tier</label>
          <select name="tier" required>
            <option value="Tier 1">Tier 1 (High)</option>
            <option value="Tier 2">Tier 2 (Medium)</option>
            <option value="Tier 3">Tier 3 (Low)</option>
          </select>
        </div>
        <div class="form-group"><label>Tugas Utama</label><input type="text" name="task" required/></div>
        <button type="submit" class="primary-btn">Simpan</button>
      </form>
    </div>
  </div>

  <!-- MODAL EDIT -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>Edit Proyek</h2>
      <form id="editForm">
        <input type="hidden" name="id"/>
        <div class="form-group"><label>Nama Proyek</label><input type="text" name="name" required/></div>
        <div class="form-group"><label>Link Dokumentasi</label><input type="url" name="link" required/></div>
        <div class="form-group"><label>Tier</label>
          <select name="tier" required>
            <option value="Tier 1">Tier 1 (High)</option>
            <option value="Tier 2">Tier 2 (Medium)</option>
            <option value="Tier 3">Tier 3 (Low)</option>
          </select>
        </div>
        <div class="form-group"><label>Tugas Utama</label><input type="text" name="task" required/></div>
        <button type="submit" class="primary-btn">Update</button>
        <button type="button" id="deleteBtn" class="secondary-btn" style="background:#c0392b;margin-top:10px;">Hapus Proyek</button>
      </form>
    </div>
  </div>

  <footer class="main-footer">
    <p>© 2025 TesNetID. Hak Cipta Dilindungi.</p>
  </footer>

  <!-- Firebase SDK (modular v9+) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    onAuthStateChanged, 
    signOut 
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    updateDoc, 
    deleteDoc, 
    doc, 
    getDoc,        // ← BARU
    onSnapshot, 
    query, 
    where, 
    orderBy, 
    serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA6PyEJO87eBadirv_mXfTuqMS8Xrl3eLw",
    authDomain: "list-tesnet.firebaseapp.com",
    projectId: "list-tesnet",
    storageBucket: "list-tesnet.appspot.com",
    messagingSenderId: "108294853368",
    appId: "1:108294853368:web:8c2c4e8e8f8e8f8e8f8e8f"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  const container = document.getElementById('testnet-list-container');

  // ==================== UI & NAV ====================
  const showSection = (id) => {
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    document.getElementById(id + '-section')?.classList.add('active');
    document.querySelectorAll('.nav-menu a').forEach(a => a.classList.toggle('active', a.dataset.target === id));
  };
  const openModal = (id) => document.getElementById(id).style.display = 'block';
  const closeModal = (id) => {
    document.getElementById(id).style.display = 'none';
    document.querySelector('#' + id + ' form')?.reset();
  };
  document.querySelectorAll('.close-btn').forEach(btn => btn.onclick = () => btn.closest('.modal').style.display = 'none');
  window.onclick = e => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; };

  document.querySelectorAll('.nav-menu a, .hero-section a[data-target]').forEach(a => {
    a.addEventListener('click', e => {
      e.preventDefault();
      const target = a.dataset.target;
      if (target === 'dashboard' && !currentUser) {
        alert('Silakan login terlebih dahulu!');
        showSection('auth');
      } else {
        showSection(target);
      }
    });
  });

  // ==================== AUTH ====================
  document.getElementById('show-register').onclick = e => { e.preventDefault(); 
    document.getElementById('login-box').classList.add('hidden');
    document.getElementById('register-box').classList.remove('hidden');
  };
  document.getElementById('show-login').onclick = e => { e.preventDefault();
    document.getElementById('register-box').classList.add('hidden');
    document.getElementById('login-box').classList.remove('hidden');
  };

  document.getElementById('register-form').onsubmit = async e => {
    e.preventDefault();
    const email = document.getElementById('reg-email').value.trim();
    const pass = document.getElementById('reg-password').value;
    const confirm = document.getElementById('reg-confirm').value;
    if (pass !== confirm) return alert('Password tidak cocok!');
    if (pass.length < 6) return alert('Password minimal 6 karakter!');
    try {
      await createUserWithEmailAndPassword(auth, email, pass);
      alert('Registrasi berhasil! Silakan login.');
    } catch (err) {
      alert('Registrasi gagal: ' + err.message);
    }
  };

  document.getElementById('login-form').onsubmit = async e => {
    e.preventDefault();
    try {
      await signInWithEmailAndPassword(auth, document.getElementById('log-email').value.trim(), document.getElementById('log-password').value);
    } catch (err) {
      alert('Login gagal: ' + err.message);
    }
  };

  const updateNav = (user) => {
    const link = document.getElementById('auth-nav-link');
    if (user) {
      link.textContent = 'Logout';
      link.onclick = e => { e.preventDefault(); signOut(auth); };
    } else {
      link.textContent = 'Login / Register';
      link.onclick = e => { e.preventDefault(); showSection('auth'); };
    }
  };

  // ==================== REALTIME LIST ====================
  const iconMap = { 'Tier 1': 'fas fa-star', 'Tier 2': 'fas fa-rocket', 'Tier 3': 'fas fa-leaf' };

  function loadProjects(uid) {
    container.innerHTML = '<p style="text-align:center;padding:60px;color:#aaa;">Memuat proyek Anda...</p>';

    const q = query(
      collection(db, "projects"),
      where("userId", "==", uid),
      orderBy("updatedAt", "desc")
    );

    onSnapshot(q, (snapshot) => {
      container.innerHTML = '';
      if (snapshot.empty) {
        container.innerHTML = '<p style="text-align:center;padding:60px;color:#aaa;">Belum ada proyek. Klik "Tambah Proyek Baru" untuk mulai!</p>';
        return;
      }
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const html = `
          <div class="testnet-card" data-id="${id}" data-tier="${data.tier}" data-status="${data.completed ? 'Selesai' : 'Aktif'}">
            <div class="card-header"><h3><i class="fas fa-code-branch"></i> ${data.name}</h3></div>
            <div class="link-info"><a href="${data.link}" target="_blank"><i class="fas fa-external-link-alt"></i> Link</a></div>
            <div class="metrics"><span><i class="${iconMap[data.tier] || 'fas fa-layer-group'}"></i> ${data.tier}</span></div>
            <div class="task-summary">${data.task}</div>
            <div class="task-item center-checkbox">
              <input type="checkbox" ${data.completed ? 'checked' : ''} onchange="toggleComplete('${id}', this.checked)">
            </div>
            <button class="secondary-btn edit-btn" onclick="openEdit('${id}')">Edit</button>
          </div>`;
        container.insertAdjacentHTML('beforeend', html);
      });
    }, (err) => {
      console.error(err);
      container.innerHTML = '<p style="color:red;text-align:center;">Gagal memuat data: ' + err.message + '</p>';
    });
  }

  // ==================== FUNGSI GLOBAL (EDIT & COMPLETE) ====================
  window.toggleComplete = async (id, checked) => {
    try {
      await updateDoc(doc(db, 'projects', id), {
        completed: checked,
        updatedAt: serverTimestamp()
      });
    } catch (err) {
      alert('Gagal update status');
      console.error(err);
    }
  };

  window.openEdit = async (id) => {
    try {
      const docSnap = await getDoc(doc(db, 'projects', id));  // ← PAKAI getDoc()
      if (!docSnap.exists()) throw new Error("Data tidak ditemukan");
      
      const data = docSnap.data();
      const form = document.getElementById('editForm');
      form.elements['id'].value = id;
      form.elements['name'].value = data.name;
      form.elements['link'].value = data.link;
      form.elements['tier'].value = data.tier;
      form.elements['task'].value = data.task;
      
      openModal('edit-modal');
    } catch (err) {
      alert('Gagal membuka edit: ' + err.message);
      console.error(err);
    }
  };

  // ==================== TAMBAH PROYEK ====================
  document.getElementById('addProjectBtn').onclick = () => openModal('add-modal');
  document.getElementById('addForm').onsubmit = async e => {
    e.preventDefault();
    if (!currentUser) return alert('Login dulu!');
    const fd = new FormData(e.target);
    try {
      await addDoc(collection(db, 'projects'), {
        name: fd.get('name').trim(),
        link: fd.get('link').trim(),
        tier: fd.get('tier'),
        task: fd.get('task').trim(),
        completed: false,
        userId: currentUser.uid,
        updatedAt: serverTimestamp()
      });
      alert('Proyek berhasil ditambahkan!');
      closeModal('add-modal');
    } catch (err) {
      alert('Gagal: ' + err.message);
    }
  };

  // ==================== EDIT & HAPUS ====================
  document.getElementById('editForm').onsubmit = async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const id = fd.get('id');
    try {
      await updateDoc(doc(db, 'projects', id), {
        name: fd.get('name').trim(),
        link: fd.get('link').trim(),
        tier: fd.get('tier'),
        task: fd.get('task').trim(),
        updatedAt: serverTimestamp()
      });
      alert('Berhasil diupdate!');
      closeModal('edit-modal');
    } catch (err) {
      alert('Gagal update: ' + err.message);
    }
  };

  document.getElementById('deleteBtn').onclick = async () => {
    if (!confirm('Yakin ingin menghapus proyek ini?')) return;
    const id = document.querySelector('#editForm [name="id"]').value;
    try {
      await deleteDoc(doc(db, 'projects', id));
      alert('Proyek dihapus');
      closeModal('edit-modal');
    } catch (err) {
      alert('Gagal menghapus');
    }
  };

  // ==================== AUTH STATE ====================
  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    updateNav(user);
    if (user) {
      showSection('dashboard');
      loadProjects(user.uid);
    } else {
      showSection('home');
      container.innerHTML = '';
    }
  });

  // ==================== FILTER & SEARCH ====================
  const applyFilters = () => {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const status = document.getElementById('filterStatus').value;
    const tier = document.getElementById('filterTier').value;
    document.querySelectorAll('.testnet-card').forEach(card => {
      const name = card.querySelector('h3')?.textContent.toLowerCase() || '';
      const cardStatus = card.dataset.status;
      const cardTier = card.dataset.tier;
      const visible = name.includes(search) && (!status || cardStatus === status) && (!tier || cardTier === tier);
      card.style.display = visible ? 'grid' : 'none';
    });
  };
  ['searchInput', 'filterStatus', 'filterTier'].forEach(id => 
    document.getElementById(id)?.addEventListener('input', applyFilters)
  );
</script>
</body>
</html>